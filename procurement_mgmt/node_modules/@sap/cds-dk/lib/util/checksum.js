const cds = require('../../lib/cds')
const { read } = cds.utils
const crypto = require('crypto')
const { getFiles } = require('../build/util')

/**
 * Calculate a checksum for a directory, excluding specified patterns.
 * @param {string} dirPath - The directory path to calculate checksum for.
 * @param {(file: string) => boolean} [filter] - the filter function to apply to the found files
 * @param {string} [hashFunction='sha256'] - The hash function to use (default is 'sha256').
 * @returns {Promise<string>} - The checksum as a hex string.
 */
async function calcDirChecksum(dirPath, filter = [], hashFunction = 'sha256', optionalFiles = []) {
  const hash = crypto.createHash(hashFunction)
  const files = await getFiles(dirPath, filter)

  for (const file of files.sort()) {
    const content = await read(file, "binary")
    hash.update(file)
    hash.update(content)
  }

  for (const file of optionalFiles.sort()) {
    const content = await read(file, "binary")
    hash.update(file)
    hash.update(content)
  }

  return hash.digest('hex')
}

module.exports = { calcDirChecksum }
